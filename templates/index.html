<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapFen - Instant Chess Analysis</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Custom Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }

        /* Background */
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1a1c2c 50%, #4a192c 100%);
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glass Navigation - Taller to accommodate title */
        .glass-nav {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            height: 120px; /* Fixed height for bigger header */
        }

        /* History Drawer Animation */
        #history-drawer { transition: transform 0.3s ease-in-out; }
        #history-drawer.open { transform: translateX(0); }
        #history-drawer.closed { transform: translateX(100%); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .loader {
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 28px; height: 28px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .btn-disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        
        .glass-section {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .feedback-tag.selected {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<!-- Added pt-32 to body to account for TALLER fixed header -->
<body class="flex flex-col text-lg lg:text-xl relative pt-32">

    <!-- TOP NAVIGATION BAR -->
    <nav class="fixed top-0 w-full z-50 glass-nav px-8 flex items-center justify-between">
        
        <!-- Empty Spacer for Flex balance (Left) -->
        <div class="hidden md:block w-40"></div>

        <!-- CENTERED LOGO & TITLE -->
        <div class="absolute left-1/2 transform -translate-x-1/2 flex items-center gap-4">
            <h1 class="text-3xl md:text-7xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400 leading-tight whitespace-nowrap transition-all duration-300">
                <i class="fa-solid fa-chess-knight mr-2 md:mr-4"></i>SnapFen
            </h1>
        </div>

        <!-- Auth Buttons (Right) -->
        <div class="flex items-center gap-6 ml-auto z-10 relative">
            {% if user.is_authenticated %}
                <!-- Authenticated State -->
                <button id="btn-history" class="flex items-center gap-2 text-gray-300 hover:text-white transition px-4 py-2 rounded-lg hover:bg-white/10">
                    <i class="fa-solid fa-clock-rotate-left text-2xl"></i>
                    <span class="hidden md:inline font-bold">History</span>
                </button>
                
                <div class="h-8 w-px bg-white/20 mx-2"></div>
                
                <span class="text-base text-gray-400 hidden md:block font-mono">
                    {{ user.username }}
                </span>
                
                <a href="/logout" class="bg-red-500/10 text-red-400 border border-red-500/20 px-5 py-2 rounded-xl text-base font-bold hover:bg-red-500/20 transition">
                    Logout
                </a>
            {% else %}
                <!-- Guest State -->
                <button onclick="window.location.href='/login'" class="text-gray-300 hover:text-white font-bold text-lg transition">
                    Log In
                </button>
                <a href="/signup" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-500/20 transition">
                    Sign Up
                </a>
            {% endif %}
        </div>
    </nav>

    <!-- HISTORY DRAWER (Right Side) -->
    <div id="history-drawer" class="fixed top-0 right-0 h-full w-96 bg-[#1a1c2c] border-l border-white/10 z-[60] closed shadow-2xl flex flex-col pt-32 px-6 pb-6 backdrop-blur-xl">
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-white/10">
            <h3 class="text-xl font-bold text-white">
                <i class="fa-solid fa-clock-rotate-left mr-2 text-purple-400"></i>Recent Scans
            </h3>
            <button id="btn-close-history" class="text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
        </div>
        
        <div id="history-list" class="flex-1 overflow-y-auto space-y-4 pr-2">
            <!-- Items injected via JS -->
            <div class="flex flex-col items-center justify-center h-40 text-gray-500 gap-2">
                <div class="loader"></div>
                <span class="text-sm">Loading history...</span>
            </div>
        </div>
    </div>
    
    <!-- Drawer Backdrop -->
    <div id="drawer-backdrop" class="fixed inset-0 bg-black/60 z-[55] hidden backdrop-blur-sm transition-opacity"></div>

    <!-- FEEDBACK BUTTON -->
    <button id="btn-open-feedback" class="fixed bottom-10 right-10 z-40 w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white rounded-full shadow-2xl shadow-blue-500/40 flex items-center justify-center transition-all hover:scale-110 group border border-white/20">
        <i class="fa-solid fa-question text-4xl"></i>
    </button>

    <!-- MAIN APP INTERFACE -->
    <main class="w-full min-h-screen flex flex-col md:flex-row animate-fade-in relative z-10">
        
        <!-- LEFT COLUMN: Controls -->
        <div class="w-full md:w-1/2 p-8 md:p-16 flex flex-col border-b md:border-b-0 md:border-r border-white/10">
            
            <!-- TITLE HEADING -->
            <div class="mb-8 text-center md:text-left">
                <h2 class="text-3xl md:text-4xl font-bold text-gray-200 leading-relaxed">
                    Upload a screenshot.<span class="text-blue-400">We'll handle the rest.</span>
                </h2>
            </div>

            <!-- Upload Zone -->
            <div id="drop-zone" class="flex-1 flex flex-col justify-center items-center border-4 border-dashed border-white/10 rounded-3xl bg-white/5 hover:bg-white/10 transition-all cursor-pointer relative group min-h-[450px] mt-4">
                <input type="file" id="file-input" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                <div class="text-center space-y-8 pointer-events-none">
                    <div class="w-36 h-36 mx-auto rounded-full bg-blue-500/20 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                        <i class="fa-solid fa-cloud-arrow-up text-7xl text-blue-400"></i>
                    </div>
                    <div>
                        <p class="text-4xl font-bold text-gray-200">Drag & drop or click</p>
                        <p class="text-xl text-gray-500 mt-3">Supports PNG, JPG, JPEG</p>
                    </div>
                </div>
            </div>

            <!-- Preview Area -->
            <div id="preview-container" class="hidden flex-1 flex flex-col mt-4">
                <div class="flex-1 relative rounded-3xl overflow-hidden border-2 border-white/20 bg-black/40 flex items-center justify-center p-4">
                    <img id="main-preview" src="" class="max-w-full max-h-[60vh] object-contain shadow-2xl rounded-lg">
                </div>
                
                <!-- Action Buttons (UPDATED: 3 Buttons Always Visible) -->
                <div class="grid grid-cols-3 gap-4 mt-8">
                    <!-- New Image Button -->
                    <button id="btn-new-image" class="py-6 px-4 bg-emerald-600 hover:bg-emerald-500 text-white text-xl rounded-2xl font-bold transition shadow-xl shadow-emerald-500/20 border border-white/10 flex flex-col items-center justify-center gap-2">
                        <i class="fa-solid fa-plus text-2xl"></i>
                        <span>New</span>
                    </button>

                    <!-- Crop Button -->
                    <button id="btn-crop-modal" class="py-6 px-4 bg-gray-800 hover:bg-gray-700 text-white text-xl rounded-2xl font-bold transition shadow-xl border border-white/10 flex flex-col items-center justify-center gap-2">
                        <i class="fa-solid fa-crop-simple text-2xl"></i>
                        <span>Crop</span>
                    </button>

                    <!-- Scan Button -->
                    <button id="btn-quick-scan" class="py-6 px-4 bg-blue-600 hover:bg-blue-500 text-white text-xl rounded-2xl font-bold transition shadow-xl shadow-blue-500/20 flex flex-col items-center justify-center gap-2">
                        <i class="fa-solid fa-bolt text-2xl"></i>
                        <span>Scan</span>
                    </button>
                </div>
            </div>

            <!-- POV Toggle -->
            <div class="mt-10 p-8 bg-white/5 rounded-2xl border border-white/10 flex items-center justify-between">
                <div class="flex items-center gap-5">
                    <div class="w-16 h-16 rounded-xl bg-black/30 flex items-center justify-center text-gray-400 text-3xl">
                        <i class="fa-solid fa-chess-board"></i>
                    </div>
                    <span class="font-bold text-3xl text-gray-200">Black's Perspective?</span>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="pov-checkbox" class="sr-only peer">
                    <div class="w-24 h-12 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-10 after:w-10 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
        </div>

        <!-- RIGHT COLUMN: Results -->
        <div class="w-full md:w-1/2 bg-black/20 backdrop-blur-sm p-8 md:p-16 flex flex-col">
            <div id="empty-result-state" class="flex-1 flex flex-col items-center justify-center text-gray-500">
                <div class="w-40 h-40 rounded-full bg-white/5 flex items-center justify-center mb-8">
                    <i class="fa-solid fa-microchip text-8xl opacity-50"></i>
                </div>
                <h3 class="text-4xl font-bold text-gray-400">Awaiting Analysis</h3>
                <p class="text-xl opacity-60 mt-3">Upload an image to start</p>
            </div>

            <div id="result-content" class="hidden space-y-14 mt-8">
                <div class="inline-flex items-center gap-4 px-8 py-4 rounded-full bg-green-500/10 text-green-400 border border-green-500/20">
                    <div class="w-4 h-4 rounded-full bg-green-400 animate-pulse"></div>
                    <span class="text-xl font-bold uppercase tracking-wider">Analysis Complete</span>
                </div>

                <div class="space-y-5">
                    <label class="text-base font-bold text-blue-400 uppercase tracking-widest">Generated FEN String</label>
                    <div class="flex group">
                        <input type="text" id="fen-text" readonly class="flex-1 p-8 bg-gray-900/80 border-2 border-gray-700 border-r-0 rounded-l-2xl font-mono text-3xl text-blue-300 focus:outline-none focus:border-blue-500 transition placeholder-gray-600" value="...">
                        <button id="btn-copy" class="bg-gray-800 border-2 border-gray-700 border-l-0 text-gray-300 px-10 rounded-r-2xl hover:bg-gray-700 hover:text-white transition active:bg-gray-600" title="Copy to Clipboard">
                            <i class="fa-regular fa-copy text-3xl"></i>
                        </button>
                    </div>
                    <p class="text-lg text-gray-500">Compatible with Lichess, Chess.com, and most engines.</p>
                </div>

                <div class="grid grid-cols-2 gap-8">
                    <a id="link-lichess" href="#" target="_blank" class="group py-6 px-8 bg-[#252529] hover:bg-[#303036] border border-white/10 rounded-2xl flex items-center justify-center gap-4 transition shadow-lg">
                        <img src="https://lichess1.org/assets/logo/lichess-favicon-32.png" class="w-10 opacity-80 group-hover:opacity-100">
                        <span class="text-2xl font-bold text-gray-300 group-hover:text-white">Lichess</span>
                    </a>
                    <a id="link-chesscom" href="#" target="_blank" class="group py-6 px-8 bg-[#312e2b] hover:bg-[#403d39] border border-white/10 rounded-2xl flex items-center justify-center gap-4 transition shadow-lg">
                        <img src="https://www.chess.com/bundles/web/images/favicon-32x32.png" class="w-10 opacity-80 group-hover:opacity-100">
                        <span class="text-2xl font-bold text-gray-300 group-hover:text-white">Chess.com</span>
                    </a>
                </div>
                
                <div class="pt-12 border-t border-white/10">
                    <p class="text-base font-bold text-gray-500 uppercase tracking-widest mb-8">Source Crop (What AI Saw)</p>
                    <img id="analyzed-preview" src="" class="w-full max-w-lg h-auto object-cover rounded-2xl border-2 border-white/10 shadow-2xl mx-auto">
                </div>
            </div>
        </div>
    </main>

    <!-- HOW TO USE SECTION -->
    <section class="glass-section py-20 px-8 border-t border-white/10">
        <div class="max-w-[100rem] mx-auto">
            <div class="text-center mb-16">
                <h2 class="text-5xl md:text-6xl font-bold text-white mb-6">How to Use</h2>
                <p class="text-2xl text-gray-400">Get your FEN in seconds with these simple steps.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-10">
                <!-- Step 1 -->
                <div class="p-10 rounded-3xl bg-white/5 border border-white/10 hover:bg-white/10 transition">
                    <div class="w-16 h-16 rounded-2xl bg-blue-500/20 flex items-center justify-center text-blue-400 text-3xl mb-8">
                        <i class="fa-solid fa-upload"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-3">1. Upload</h3>
                    <p class="text-gray-400 leading-relaxed">Upload a clear screenshot of your chessboard from any site or app.</p>
                </div>

                <!-- Step 2 -->
                <div class="p-10 rounded-3xl bg-white/5 border border-white/10 hover:bg-white/10 transition">
                    <div class="w-16 h-16 rounded-2xl bg-purple-500/20 flex items-center justify-center text-purple-400 text-3xl mb-8">
                        <i class="fa-solid fa-crop-simple"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-3">2. Crop</h3>
                    <p class="text-gray-400 leading-relaxed">Use the crop tool to remove UI elements. Keep ONLY the board visible.</p>
                </div>

                <!-- Step 3 -->
                <div class="p-10 rounded-3xl bg-white/5 border-2 border-orange-500/20 hover:bg-white/10 transition relative overflow-hidden">
                    <div class="absolute top-0 right-0 bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-bl-xl">IMPORTANT</div>
                    <div class="w-16 h-16 rounded-2xl bg-orange-500/20 flex items-center justify-center text-orange-400 text-3xl mb-8">
                        <i class="fa-solid fa-toggle-on"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-3">3. Perspective</h3>
                    <p class="text-gray-400 leading-relaxed">Playing as <strong>Black</strong>? Toggle the switch. We assume White is at bottom by default.</p>
                </div>

                <!-- Step 4 -->
                <div class="p-10 rounded-3xl bg-white/5 border border-white/10 hover:bg-white/10 transition">
                    <div class="w-16 h-16 rounded-2xl bg-green-500/20 flex items-center justify-center text-green-400 text-3xl mb-8">
                        <i class="fa-solid fa-chess"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-3">4. Get FEN</h3>
                    <p class="text-gray-400 leading-relaxed">Click <strong>Scan Board</strong> to generate the FEN instantly. It copies easily to any chess engine.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- FOOTER -->
    <footer class="bg-[#0b1120] border-t border-white/10 pt-20 pb-10 px-8 mt-auto">
        <div class="max-w-[90rem] mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-12 mb-16">
                <div class="space-y-6">
                    <h4 class="text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">SnapFen</h4>
                    <p class="text-gray-400 text-lg leading-relaxed">Bridging the gap between physical boards and digital analysis. The fastest way to digitize your chess games.</p>
                    <div class="flex items-center gap-2 text-green-400 bg-green-400/10 px-4 py-2 rounded-full w-fit border border-green-400/20">
                        <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                        <span class="text-sm font-bold uppercase tracking-wider">System Operational</span>
                    </div>
                </div>
                <div class="space-y-6">
                    <h5 class="text-xl font-bold text-white uppercase tracking-widest">Navigation</h5>
                    <ul class="space-y-4 text-lg text-gray-400">
                        <li><a href="#" class="hover:text-blue-400 transition">Upload Image</a></li>
                        <li><a href="#" class="hover:text-blue-400 transition">How it Works</a></li>
                        <li><a href="#" class="hover:text-blue-400 transition">API Documentation</a></li>
                        <li><a href="#" class="hover:text-blue-400 transition">Report a Bug</a></li>
                    </ul>
                </div>
                <div class="space-y-6">
                    <h5 class="text-xl font-bold text-white uppercase tracking-widest">Powered By</h5>
                    <div class="flex flex-wrap gap-3">
                        <span class="px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-gray-300 text-sm font-mono">TensorFlow</span>
                        <span class="px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-gray-300 text-sm font-mono">OpenCV</span>
                        <span class="px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-gray-300 text-sm font-mono">Flask</span>
                        <span class="px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-gray-300 text-sm font-mono">EfficientNet</span>
                    </div>
                </div>
                <div class="space-y-6">
                    <h5 class="text-xl font-bold text-white uppercase tracking-widest">Connect</h5>
                    <p class="text-gray-400 text-lg">ðŸš€ Got a query, a bug to squash, or a brilliant idea? <br><span class="text-blue-400 font-semibold">Let's connect and build something cool.</span></p>
                    <div class="flex gap-5">
                        <a href="https://github.com/Prajjwal-Vish" class="w-14 h-14 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-gray-400 hover:bg-blue-600 hover:text-white hover:-translate-y-1 transition-all duration-300 shadow-lg"><i class="fa-brands fa-github text-3xl"></i></a>
                        <a href="https://x.com/prajjwal_vish" class="w-14 h-14 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-gray-400 hover:bg-blue-400 hover:text-white hover:-translate-y-1 transition-all duration-300 shadow-lg"><i class="fa-brands fa-twitter text-3xl"></i></a>
                        <a href="#" class="w-14 h-14 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-gray-400 hover:bg-pink-600 hover:text-white hover:-translate-y-1 transition-all duration-300 shadow-lg"><i class="fa-brands fa-instagram text-3xl"></i></a>
                        <a href="https://www.linkedin.com/in/prajjwal-vishwakarma-1564b1230/" class="w-14 h-14 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-gray-400 hover:bg-blue-700 hover:text-white hover:-translate-y-1 transition-all duration-300 shadow-lg"><i class="fa-brands fa-linkedin-in text-3xl"></i></a>
                    </div>
                </div>
            </div>
            <div class="pt-8 border-t border-white/5 flex flex-col md:flex-row justify-between items-center gap-4 text-gray-600">
                <div class="text-base">&copy; 2025 SnapFen. v1.2.0 (Beta)</div>
                <div class="flex gap-8 text-base"><a href="#" class="hover:text-gray-400 transition">Privacy</a><a href="#" class="hover:text-gray-400 transition">Terms</a></div>
            </div>
        </div>
    </footer>

    <!-- FEEDBACK MODAL -->
    <div id="feedback-modal" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-md animate-fade-in">
        <div class="bg-[#1a1c2c] border border-white/10 rounded-3xl overflow-hidden shadow-2xl w-full max-w-lg flex flex-col animate-slide-up">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-[#0f172a]">
                <h3 class="text-2xl font-bold text-gray-200 flex items-center gap-3">
                    <i class="fa-solid fa-message text-blue-400"></i> Feedback
                </h3>
                <button id="btn-close-feedback" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-gray-400 transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="p-8 space-y-6">
                <p class="text-gray-400">Did the AI get it wrong? Highlight the issue so we can train it better.</p>
                <div>
                    <label class="block text-sm font-bold text-gray-500 uppercase tracking-widest mb-3">What went wrong?</label>
                    <div class="flex flex-wrap gap-3" id="feedback-tags">
                        <button class="feedback-tag px-4 py-2 rounded-lg border border-white/10 bg-white/5 text-gray-300 hover:bg-white/10 transition">Wrong Piece</button>
                        <button class="feedback-tag px-4 py-2 rounded-lg border border-white/10 bg-white/5 text-gray-300 hover:bg-white/10 transition">Wrong Color</button>
                        <button class="feedback-tag px-4 py-2 rounded-lg border border-white/10 bg-white/5 text-gray-300 hover:bg-white/10 transition">Bad Crop</button>
                        <button class="feedback-tag px-4 py-2 rounded-lg border border-white/10 bg-white/5 text-gray-300 hover:bg-white/10 transition">Other</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-500 uppercase tracking-widest mb-3">Details (Optional)</label>
                    <textarea id="feedback-text" rows="3" class="w-full p-4 bg-black/30 border border-white/10 rounded-xl text-gray-300 focus:outline-none focus:border-blue-500 transition resize-none" placeholder="e.g. The pawn on E4 is actually a Bishop..."></textarea>
                </div>
                <div class="flex items-center gap-3 p-4 bg-blue-500/10 rounded-xl border border-blue-500/20">
                    <i class="fa-solid fa-circle-info text-blue-400"></i>
                    <span class="text-sm text-blue-300">We'll automatically attach the current board image & FEN for debugging.</span>
                </div>
            </div>
            <div class="p-6 border-t border-white/10 bg-[#0f172a] flex justify-end">
                <button id="btn-submit-feedback" class="py-3 px-8 bg-blue-600 hover:bg-blue-500 text-white text-lg rounded-xl font-bold transition shadow-lg flex items-center gap-2">
                    <span>Send Report</span>
                    <i class="fa-regular fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- CROP MODAL -->
    <div id="crop-modal" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-md animate-fade-in">
        <div class="bg-[#1a1c2c] border border-white/10 rounded-3xl overflow-hidden shadow-2xl w-full max-w-5xl flex flex-col h-[85vh]">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-[#0f172a]">
                <h3 class="text-2xl font-bold text-gray-200 flex items-center gap-3"><i class="fa-solid fa-crop-simple text-blue-400"></i> Adjust Crop Area</h3>
                <button id="btn-close-modal" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-gray-400 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex-1 bg-black relative overflow-hidden flex items-center justify-center">
                <div class="h-full w-full p-4"><img id="crop-image-target" src="" class="max-w-full max-h-full block mx-auto"></div>
            </div>
            <div class="p-6 border-t border-white/10 bg-[#0f172a] flex justify-end gap-4">
                <button id="btn-confirm-crop" class="py-4 px-10 bg-blue-600 hover:bg-blue-500 text-white text-lg rounded-xl font-bold transition shadow-lg shadow-blue-900/50">Confirm & Analyze</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        // --- VARIABLES ---
        let cropper = null;
        let currentActiveBlob = null;
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.getElementById('preview-container');
        const mainPreview = document.getElementById('main-preview');
        const btnCropModal = document.getElementById('btn-crop-modal');
        const btnNewImage = document.getElementById('btn-new-image');
        const btnQuickScan = document.getElementById('btn-quick-scan');
        const povCheckbox = document.getElementById('pov-checkbox');
        const cropModal = document.getElementById('crop-modal');
        const cropImageTarget = document.getElementById('crop-image-target');
        const btnCloseModal = document.getElementById('btn-close-modal');
        const btnConfirmCrop = document.getElementById('btn-confirm-crop');
        const resultContent = document.getElementById('result-content');
        const emptyState = document.getElementById('empty-result-state');
        const fenText = document.getElementById('fen-text');
        const btnCopy = document.getElementById('btn-copy');
        const analyzedPreview = document.getElementById('analyzed-preview');
        
        const btnOpenFeedback = document.getElementById('btn-open-feedback');
        const feedbackModal = document.getElementById('feedback-modal');
        const btnCloseFeedback = document.getElementById('btn-close-feedback');
        const btnSubmitFeedback = document.getElementById('btn-submit-feedback');
        const feedbackTags = document.querySelectorAll('.feedback-tag');

        const btnHistory = document.getElementById('btn-history');
        const historyDrawer = document.getElementById('history-drawer');
        const historyList = document.getElementById('history-list');
        const drawerBackdrop = document.getElementById('drawer-backdrop');
        const btnCloseHistory = document.getElementById('btn-close-history');

        fileInput.addEventListener('change', handleFileSelect);
        function handleFileSelect(e) {
            if (e.target.files && e.target.files[0]) {
                currentActiveBlob = e.target.files[0];
                const url = URL.createObjectURL(currentActiveBlob);
                mainPreview.src = url;
                dropZone.classList.add('hidden');
                previewContainer.classList.remove('hidden');
                resetResults();
                
                // RESET THE INPUT VALUE! This fixes the "can't select same file twice" bug.
                fileInput.value = ''; 
            }
        }

        povCheckbox.addEventListener('change', () => {
            if (btnQuickScan.classList.contains('btn-disabled')) {
                btnQuickScan.disabled = false;
                btnQuickScan.classList.remove('btn-disabled', 'opacity-50');
                btnQuickScan.innerHTML = '<i class="fa-solid fa-rotate"></i> Update FEN';
            }
        });

        btnCropModal.addEventListener('click', () => {
            cropModal.classList.remove('hidden');
            cropImageTarget.src = mainPreview.src;
            if(cropper) cropper.destroy();
            cropper = new Cropper(cropImageTarget, { aspectRatio: 1, viewMode: 1, dragMode: 'move', autoCropArea: 0.95, guides: true, center: true, background: false, modal: true });
        });

        btnCloseModal.addEventListener('click', () => { cropModal.classList.add('hidden'); if(cropper) cropper.destroy(); });

        btnConfirmCrop.addEventListener('click', () => {
            if(!cropper) return;
            cropper.getCroppedCanvas({ width: 512, height: 512 }).toBlob((blob) => {
                currentActiveBlob = blob;
                cropModal.classList.add('hidden');
                sendToBackend(currentActiveBlob, "cropped.png");
            }, 'image/png');
        });

        btnQuickScan.addEventListener('click', () => { if(currentActiveBlob) sendToBackend(currentActiveBlob, "scan.png"); });
        btnNewImage.addEventListener('click', () => fileInput.click());

        btnOpenFeedback.addEventListener('click', () => feedbackModal.classList.remove('hidden'));
        btnCloseFeedback.addEventListener('click', () => feedbackModal.classList.add('hidden'));
        feedbackTags.forEach(tag => {
            tag.addEventListener('click', () => {
                feedbackTags.forEach(t => t.classList.remove('selected'));
                tag.classList.add('selected');
            });
        });

        btnSubmitFeedback.addEventListener('click', () => {
            const text = document.getElementById('feedback-text').value;
            const activeTags = Array.from(document.querySelectorAll('.feedback-tag.selected')).map(el => el.innerText).join(', ');
            const formData = new FormData();
            formData.append('feedback', text);
            formData.append('tags', activeTags || 'General Issue');
            formData.append('fen', fenText.value);
            if (currentActiveBlob) formData.append('original_image', currentActiveBlob, 'original.png');
            
            const originalHTML = btnSubmitFeedback.innerHTML;
            btnSubmitFeedback.innerHTML = '<div class="loader w-6 h-6 border-2"></div> Sending...';
            btnSubmitFeedback.disabled = true;

            fetch('/report_issue', { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                btnSubmitFeedback.innerHTML = '<i class="fa-solid fa-check"></i> Sent!';
                btnSubmitFeedback.classList.replace('bg-blue-600', 'bg-green-600');
                setTimeout(() => {
                    feedbackModal.classList.add('hidden');
                    btnSubmitFeedback.innerHTML = originalHTML;
                    btnSubmitFeedback.disabled = false;
                    btnSubmitFeedback.classList.replace('bg-green-600', 'bg-blue-600');
                    document.getElementById('feedback-text').value = '';
                    feedbackTags.forEach(t => t.classList.remove('selected'));
                }, 2000);
            })
            .catch(err => { console.error(err); btnSubmitFeedback.innerHTML = 'Error. Try again.'; btnSubmitFeedback.disabled = false; });
        });

        if (btnHistory) {
            btnHistory.addEventListener('click', () => {
                historyDrawer.classList.remove('closed');
                historyDrawer.classList.add('open');
                drawerBackdrop.classList.remove('hidden');
                fetchHistory();
            });
        }
        function closeDrawer() {
            historyDrawer.classList.remove('open');
            historyDrawer.classList.add('closed');
            drawerBackdrop.classList.add('hidden');
        }
        if(btnCloseHistory) btnCloseHistory.addEventListener('click', closeDrawer);
        if(drawerBackdrop) drawerBackdrop.addEventListener('click', closeDrawer);

        function fetchHistory() {
            fetch('/api/history')
            .then(res => res.json())
            .then(data => {
                historyList.innerHTML = '';
                if (data.length === 0) {
                    historyList.innerHTML = '<p class="text-gray-500 text-center mt-10">No scans yet.</p>';
                    return;
                }
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'p-4 bg-white/5 rounded-xl border border-white/10 hover:bg-white/10 cursor-pointer transition group';
                    div.innerHTML = `
                        <div class="flex gap-4 items-center">
                            <img src="${item.image}" class="w-16 h-16 rounded-lg object-cover border border-white/20">
                            <div class="overflow-hidden flex-1">
                                <p class="text-xs text-gray-400 mb-1">${item.date}</p>
                                <p class="text-sm font-mono text-blue-300 truncate w-full bg-black/30 p-1 rounded">${item.fen}</p>
                            </div>
                        </div>
                    `;
                    div.addEventListener('click', () => { showResult(item.fen, item.image); closeDrawer(); });
                    historyList.appendChild(div);
                });
            });
        }

        function sendToBackend(fileBlob, fileName) {
            setLoading(true);
            const formData = new FormData();
            formData.append('file', fileBlob, fileName);
            const isBlack = document.getElementById('pov-checkbox').checked;
            formData.append('pov', isBlack ? 'b' : 'w');
            fetch('/predict', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => { setLoading(false); if(data.error) alert(data.error); else showResult(data.fen, data.cropped_image); })
            .catch(err => { setLoading(false); console.error(err); alert("Server Error."); });
        }

        function setLoading(isLoading) {
            if (isLoading) {
                // Only disable scan/crop/new buttons visually but keep layout
                btnQuickScan.innerHTML = '<div class="loader"></div>';
                btnConfirmCrop.innerHTML = '<div class="loader"></div>';
                btnQuickScan.disabled = true; 
                btnConfirmCrop.disabled = true; 
                btnCropModal.disabled = true; 
                btnNewImage.disabled = true;
                
                resultContent.classList.add('opacity-50');
            } else {
                btnQuickScan.innerHTML = '<i class="fa-solid fa-bolt text-2xl"></i> <span>Scan</span>';
                btnConfirmCrop.innerHTML = 'Confirm & Analyze';
                btnQuickScan.disabled = false; 
                btnConfirmCrop.disabled = false; 
                btnCropModal.disabled = false; 
                btnNewImage.disabled = false;
                
                resultContent.classList.remove('opacity-50');
            }
        }

        function showResult(fen, base64Image) {
            emptyState.classList.add('hidden');
            resultContent.classList.remove('hidden');
            resultContent.classList.add('animate-fade-in');
            fenText.value = fen;
            if (base64Image) analyzedPreview.src = base64Image;
            document.getElementById('link-lichess').href = `https://lichess.org/analysis/${fen}`;
            document.getElementById('link-chesscom').href = `https://www.chess.com/analysis?fen=${fen}`;
            
            // Buttons Logic: Keep all visible but disable scan until change
            btnQuickScan.classList.add('btn-disabled', 'opacity-50');
        }

        function resetResults() {
            emptyState.classList.remove('hidden');
            resultContent.classList.add('hidden');
            
            // Reset button states
            btnQuickScan.classList.remove('btn-disabled', 'opacity-50');
            btnQuickScan.innerHTML = '<i class="fa-solid fa-bolt text-2xl"></i> <span>Scan</span>';
        }

        btnCopy.addEventListener('click', () => {
            fenText.select(); document.execCommand('copy');
            const icon = btnCopy.querySelector('i');
            icon.className = 'fa-solid fa-check text-green-400';
            setTimeout(() => icon.className = 'fa-regular fa-copy', 2000);
        });
    </script>
</body>
</html>